<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>全景过渡测试</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>

<div  style="background: #ff0000;position: fixed;left:30%; font-size: 36px" id="test" > 全景过渡:4原装备件->5物有所值 </div>
<div  style="background: #ff0000;position: fixed;font-size: 36px" id="reset" > 重置 </div>

<script src="js/three.js"></script>
<script type="text/javascript" src="js/OrbitControls.js"></script>
<script type="text/javascript" src="js/Tween.js"></script>
<script type="x-shader/x-vertex" id="vertexshader">

        varying vec3 pos;

        void main(void){

        mat4 mvp = projectionMatrix * modelViewMatrix ;

        pos = position.xyz;

       // pos = vec3(-position.x,position.yz);

        gl_Position  = mvp * vec4(pos,1.0);

        }

</script>

<script type="x-shader/x-fragment" id="fragmentshader">


        varying vec3 pos;

        uniform samplerCube U_MainTexture;

        uniform float alpha;

        void main(void){

            gl_FragColor =  vec4(textureCube(U_MainTexture,pos).rgb,alpha);//取观察点到面 的向量

      }

</script>


<div id="WebGL-output"></div>

<script>
    var camera, scene, renderer, control;

    function init() {

        var uniforms;

        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer();

        renderer.setSize(window.innerWidth, window.innerHeight);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
       // camera.position.z = 40;
         camera.position.x = -1;


        // camera.lookAt(new THREE.Vector3(0,0,1))

        control = new THREE.OrbitControls(camera);

        control.rotateSpeed = -1;
        control.target.set(-0.99999999,0,0);


        var cubeGeo = new THREE.CubeGeometry(10, 10, 10);
        var cubeGeo2 = new THREE.CubeGeometry(10, 10, 10);

        var path = "./data/";
        var format = '.jpg';

        var urls = [
            path + 'nx' + format, path + 'px' + format,
            path + 'py' + format, path + 'ny' + format,
            path + 'nz' + format, path + 'pz' + format
        ];
        var urls1 = [
            path + 'nx (1)' + format, path + 'px (1)' + format,
            path + 'py (1)' + format, path + 'ny (1)' + format,
            path + 'nz (1)' + format, path + 'pz (1)' + format
        ];
        var urls2 = [
            path + 'nx (2)' + format, path + 'px (2)' + format,
            path + 'py (2)' + format, path + 'ny (2)' + format,
            path + 'nz (2)' + format, path + 'pz (2)' + format
        ];
        var urls3 = [
            path + 'nx (3)' + format, path + 'px (3)' + format,
            path + 'py (3)' + format, path + 'ny (3)' + format,
            path + 'nz (3)' + format, path + 'pz (3)' + format
        ];

        var urls4 = [
            path + 'nx (4)' + format, path + 'px (4)' + format,
            path + 'py (4)' + format, path + 'ny (4)' + format,
            path + 'nz (4)' + format, path + 'pz (4)' + format
        ];
        var urls5 = [
            path + 'nx (5)' + format, path + 'px (5)' + format,
            path + 'py (5)' + format, path + 'ny (5)' + format,
            path + 'nz (5)' + format, path + 'pz (5)' + format
        ];
        var urls6 = [
            path + 'nx (6)' + format, path + 'px (6)' + format,
            path + 'py (6)' + format, path + 'ny (6)' + format,
            path + 'nz (6)' + format, path + 'pz (6)' + format
        ];
        var urls7 = [
            path + 'nx (7)' + format, path + 'px (7)' + format,
            path + 'py (7)' + format, path + 'ny (7)' + format,
            path + 'nz (7)' + format, path + 'pz (7)' + format
        ];
        var urls8 = [
            path + 'nx (8)' + format, path + 'px (8)' + format,
            path + 'py (8)' + format, path + 'ny (8)' + format,
            path + 'nz (8)' + format, path + 'pz (8)' + format
        ];

        var cubeText = new THREE.CubeTextureLoader().load( urls)
        var cubeText1 = new THREE.CubeTextureLoader().load( urls1 )
        var cubeText2 = new THREE.CubeTextureLoader().load( urls2 )
        var cubeText3 = new THREE.CubeTextureLoader().load( urls3 )
        var cubeText4 = new THREE.CubeTextureLoader().load( urls4 )
        var cubeText5 = new THREE.CubeTextureLoader().load( urls5 )
        var cubeText6 = new THREE.CubeTextureLoader().load( urls6 )
        var cubeText7 = new THREE.CubeTextureLoader().load( urls7 )
        var cubeText8 = new THREE.CubeTextureLoader().load( urls8 )

        uniforms = {
            U_MainTexture:{ value :  cubeText4  },
            alpha:{value:1.0}
        };

        var shaderMaterial = new THREE.ShaderMaterial(
            {
                side: THREE.BackSide,
                // side:THREE.DoubleSide,
                uniforms: uniforms,
                vertexShader: document.getElementById('vertexshader').textContent,
                fragmentShader: document.getElementById(('fragmentshader')).textContent,
                depthTest: false,
                transparent: true

            });

        var uniforms2 = {
            U_MainTexture:{ value :  cubeText5  },

            alpha:{value:1.0}

        };

        var shaderMaterial2 = new THREE.ShaderMaterial(
            {
                side: THREE.BackSide,
                // side:THREE.DoubleSide,
                uniforms: uniforms2,
                vertexShader: document.getElementById('vertexshader').textContent,
                fragmentShader: document.getElementById(('fragmentshader')).textContent,
                depthTest: false,
                transparent: true

            });

        var cube = new THREE.Mesh(cubeGeo, shaderMaterial);
        var cube2 = new THREE.Mesh(cubeGeo2, shaderMaterial2);




        cube.scale.x = -1;
        scene.add(cube2);

        cube2.scale.x = -1;
        scene.add(cube);

        cube2.material.uniforms.alpha.value = 0.0;

        document.getElementById('reset').addEventListener('click',function (ev) {


            cube.material.uniforms.alpha.value = 1.0;

            cube2.material.uniforms.alpha.value = 0.0 ;


        });
        document.getElementById('test').addEventListener('click',function (ev) {

            new TWEEN.Tween(camera.position)
                .to({
                    x:2,
                    y:0,
                    z:0
                },2000)
                .easing(TWEEN.Easing.Linear.None)

                .onUpdate(function (xhr) {

                    control.target.set(xhr.x+camera.getWorldDirection().x,xhr.y+camera.getWorldDirection().y,xhr.z+camera.getWorldDirection().z);

                    if(xhr.x >0)
                    {
                        cube.position.set(xhr.x,xhr.y,xhr.z);
                        cube.material.uniforms.alpha.value = (2.0 - xhr.x )/3.0;
                        cube2.material.uniforms.alpha.value = 1.0 - ((2.0 - xhr.x )/3.0) ;
                        camera.fov  =50 ;
                        camera.updateProjectionMatrix();

                    }else
                    {
                        camera.fov  =-25*(xhr.x+1) +50 ;
                        camera.updateProjectionMatrix();
                    }

                    cube2.position.set(xhr.x,xhr.y,xhr.z);





                })
                .onComplete( function () {

                        //console.log(camera.position)

                        cube2.material.uniforms.alpha.value =1.0
                      /*  camera.position.set(0,0,0);
                        control.target.set(0.01,0,0);*/
                        /*      camera.position.set(-2,0,0);
                              control.target.set(-1.9,0,0);

                          new TWEEN.Tween(camera.position)
                              .to({
                                  x:0,
                                  y:0,
                                  z:0
                              },1000)
                              .easing(TWEEN.Easing.Linear.None)

                              .onUpdate(function (xhr) {
                                  control.target.set(xhr.x+0.01,0,0);

                              }).start();*/


                    }
                ).start();


        });

        document.getElementById('test').addEventListener('touchstart',function (ev) {

            new TWEEN.Tween(camera.position)
                .to({
                    x:2,
                    y:0,
                    z:0
                },1000)
                .easing(TWEEN.Easing.Linear.None)

                .onUpdate(function (xhr) {
                    control.target.set(xhr.x+0.01,0,0);

                    cube.material.uniforms.alpha.value = (2.0 - xhr.x )/3.0;

                    cube2.material.uniforms.alpha.value = 1.0 - ((2.0 - xhr.x )/3.0) ;

                })
                .onComplete( function () {

                        //console.log(camera.position)

                        cube2.material.uniforms.alpha.value =1.0
                      //  camera.position.set(0,0,0);
                     //   control.target.set(0.01,0,0);
                        /*      camera.position.set(-2,0,0);
                              control.target.set(-1.9,0,0);

                          new TWEEN.Tween(camera.position)
                              .to({
                                  x:0,
                                  y:0,
                                  z:0
                              },1000)
                              .easing(TWEEN.Easing.Linear.None)

                              .onUpdate(function (xhr) {
                                  control.target.set(xhr.x+0.01,0,0);

                              }).start();*/


                    }
                ).start();


        });

        document.getElementById('reset').addEventListener('touchstart',function (ev) {


            cube.material.uniforms.alpha.value = 1.0;

            cube2.material.uniforms.alpha.value = 0.0 ;


        });


        document.getElementById('WebGL-output').appendChild(renderer.domElement);
        animate();
    }

    function rend() {
        control.update();
        renderer.render(scene, camera);
    }

    function animate() {

        TWEEN.update();

        rend();
        requestAnimationFrame(animate);
    }

    init();
</script>

</body>
</html>